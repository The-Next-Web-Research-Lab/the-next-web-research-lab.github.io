<!DOCTYPE html>
<html class="w-full h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>React</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="w-full h-full">
<div id="root" class="w-full h-full"></div>

<script type="text/babel">
  const Button = ({children, ...props}) => {
    return (
      <button
        type="text"
        className="py-2 px-4 bg-slate-900 text-white rounded-lg text-sm"
        {...props}
      >
        {children}
      </button>
    )
  };

  const GetSomething = () => {
    const [message, setMessage] = React.useState('');
    const getFile = async () => {
      try {
        const [fileHandle] = await window.showOpenFilePicker({
          types: [
            {
              description: 'Images',
              accept: {
                'image/*': ['.png', '.gif', '.jpeg', '.jpg']
              }
            },
          ],
          excludeAcceptAllOption: true,
          multiple: false
        });
        setMessage(`fileHandle.kind is ${fileHandle.kind}`)
      } catch (error) {
        setMessage(`error: ${error}`)
      }
    }
    const getDir = async () => {
      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'read',
          startIn: 'desktop'
        });
        setMessage(`dirHandle.kind is ${dirHandle.kind}`)
      } catch (error) {
        setMessage(`error: ${error}`)
      }
    }

    return (
      <>
        <div>
          <Button onClick={getFile}>
            Get File
          </Button>{' '}
          <Button onClick={getDir}>
            Get Dir
          </Button>
        </div>
        <p>message: {message}</p>
      </>
    )
  };

  const CreateDir = () => {
    const [message, setMessage] = React.useState('');
    const createDir = async () => {
      try {
        const dirHandle = await window.showDirectoryPicker({
          mode: 'readwrite',
          startIn: 'desktop'
        });
        const directoryName = `new-${Date.now()}`;
        await dirHandle.getDirectoryHandle(directoryName, {create: true})
        setMessage(`${directoryName} is created. please check your directory`);
      } catch (error) {
        setMessage(`error: ${error}`)
      }
    }

    return (
      <>
        <div>
          <Button onClick={createDir}>
            Create Dir
          </Button>
        </div>
        <p>message: {message}</p>
      </>
    )
  };

  const SaveFile = () => {
    const [message, setMessage] = React.useState('');
    const [writableStream, setWritableStream] = React.useState(null);
    const [text, setText] = React.useState('');

    const handleChangeText = async (event) => {
      setText(() => event.target.value);
      await writableStream.write({
        type: "truncate",
        size: 0
      });
      await writableStream.write({
        type: "write",
        position: 0,
        data: event.target.value
      });
    };

    const createFile = async () => {
      try {
        setMessage(`creating`);
        const fileHandle = await window.showSaveFilePicker();
        const writableStream = await fileHandle.createWritable();

        setWritableStream(writableStream);
        setMessage(`success`);
      } catch (error) {
        setMessage(`error: ${error}`)
      }
    };

    const closeFile = async () => {
      try {
        setMessage(`saving`);
        await writableStream.close();
        setMessage(`success`);
      } catch (error) {
        setMessage(`error: ${error}`)
      } finally {
        setText('');
        setWritableStream(null);
      }
    }

    const readFile = async () => {
      try {
        setMessage(`reading`);
        const [fileHandle] = await window.showOpenFilePicker();
        const file = await fileHandle.getFile();
        const text = await file.text();
        const writableStream = await fileHandle.createWritable();

        setText(text);
        setWritableStream(writableStream)
        setMessage(`success`);
      } catch (error) {
        setMessage(`error: ${error}`)
      }
    };

    return (
      <>
        <div>
          <Button onClick={createFile}>
            Create File
          </Button>{' '}
          <Button onClick={closeFile}>
            Close File
          </Button>{' '}
          <Button onClick={readFile}>
            Read File
          </Button>
        </div>
        <p>message: {message}</p>
        <div>
          {
            writableStream &&
            <textarea
              value={text}
              onChange={handleChangeText}
              className="w-[80%] h-[100px] py-2 px-4 border border-slate-900 rounded-lg text-sm"
            >
            </textarea>
          }
        </div>
      </>
    )
  };

  const MyApp = () => {

    return <div className="h-full w-full text-xl text-center flex flex-col gap-y-5 pt-5">
      <GetSomething />
      <CreateDir />
      <SaveFile />
    </div>;
  }

  ReactDOM
    .createRoot(document.querySelector('#root'))
    .render(<MyApp />);
</script>
</body>
</html>